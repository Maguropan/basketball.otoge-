<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèÄ DRIBBLE MASTER PC</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Righteous&family=Kanit:wght@700;900&display=swap');
        
        :root {
            --orange: #FF6B35;
            --dark-orange: #C4501D;
            --blue: #004E89;
            --yellow: #FFD23F;
            --dark: #1A1A2E;
            --court: #8B4513;
            --white: #F7F7F7;
            --neon-green: #39FF14;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Kanit', sans-serif;
            background: linear-gradient(135deg, var(--dark) 0%, #2d2d44 100%);
            color: var(--white);
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        /* Background Animation */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(255, 107, 53, 0.03) 2px, rgba(255, 107, 53, 0.03) 4px),
                repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(255, 107, 53, 0.03) 2px, rgba(255, 107, 53, 0.03) 4px);
            pointer-events: none;
            animation: scan 8s linear infinite;
            z-index: 0;
        }
        
        @keyframes scan {
            0% { transform: translateY(0); }
            100% { transform: translateY(20px); }
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }
        
        header {
            text-align: center;
            padding: 30px 0;
            position: relative;
        }
        
        h1 {
            font-family: 'Bebas Neue', cursive;
            font-size: 5rem;
            color: var(--orange);
            text-shadow: 
                0 0 10px var(--orange),
                0 0 20px var(--orange),
                0 0 30px var(--orange),
                4px 4px 0 var(--dark-orange);
            letter-spacing: 8px;
            margin-bottom: 10px;
            animation: glow 2s ease-in-out infinite alternate;
        }
        
        @keyframes glow {
            from { text-shadow: 0 0 10px var(--orange), 0 0 20px var(--orange), 4px 4px 0 var(--dark-orange); }
            to { text-shadow: 0 0 20px var(--orange), 0 0 40px var(--orange), 0 0 60px var(--orange), 4px 4px 0 var(--dark-orange); }
        }
        
        .subtitle {
            font-family: 'Righteous', cursive;
            font-size: 1.5rem;
            color: var(--yellow);
            text-transform: uppercase;
            letter-spacing: 4px;
        }
        
        .setup-panel {
            background: rgba(0, 78, 137, 0.2);
            border: 3px solid var(--blue);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 
                0 0 30px rgba(0, 78, 137, 0.5),
                inset 0 0 20px rgba(255, 107, 53, 0.1);
        }
        
        .setup-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .input-group {
            position: relative;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.9rem;
            color: var(--yellow);
            letter-spacing: 2px;
        }
        
        input[type="file"],
        input[type="number"],
        select {
            width: 100%;
            padding: 12px;
            background: rgba(26, 26, 46, 0.8);
            border: 2px solid var(--orange);
            border-radius: 8px;
            color: var(--white);
            font-family: 'Kanit', sans-serif;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        input[type="file"]:hover,
        input[type="number"]:hover,
        select:hover {
            border-color: var(--yellow);
            box-shadow: 0 0 15px rgba(255, 107, 53, 0.5);
        }
        
        input[type="file"]::file-selector-button {
            background: var(--orange);
            color: var(--white);
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Kanit', sans-serif;
            font-weight: 700;
            margin-right: 10px;
        }
        
        .btn {
            padding: 15px 40px;
            background: linear-gradient(135deg, var(--orange) 0%, var(--dark-orange) 100%);
            color: var(--white);
            border: none;
            border-radius: 10px;
            font-family: 'Kanit', sans-serif;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
            box-shadow: 
                0 4px 15px rgba(255, 107, 53, 0.4),
                0 0 20px rgba(255, 107, 53, 0.2);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 6px 20px rgba(255, 107, 53, 0.6),
                0 0 30px rgba(255, 107, 53, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            background: #555;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        #game-container {
            display: none;
            position: relative;
        }
        
        #game-canvas {
            width: 100%;
            max-width: 1000px;
            height: 600px;
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            border: 4px solid var(--orange);
            border-radius: 15px;
            display: block;
            margin: 0 auto;
            box-shadow: 
                0 0 40px rgba(255, 107, 53, 0.6),
                inset 0 0 30px rgba(0, 0, 0, 0.5);
        }
        
        .score-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
            padding: 20px;
            background: rgba(0, 78, 137, 0.15);
            border: 2px solid var(--blue);
            border-radius: 10px;
        }
        
        .score-item {
            text-align: center;
            padding: 15px;
            background: rgba(26, 26, 46, 0.6);
            border-radius: 8px;
            border: 2px solid var(--orange);
        }
        
        .score-label {
            font-size: 0.9rem;
            color: var(--yellow);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 5px;
        }
        
        .score-value {
            font-size: 2rem;
            font-weight: 900;
            color: var(--white);
            text-shadow: 0 0 10px var(--neon-green);
        }
        
        .controls {
            margin-top: 20px;
            text-align: center;
        }
        
        .key-guide {
            display: inline-flex;
            gap: 30px;
            margin-top: 15px;
            padding: 20px;
            background: rgba(26, 26, 46, 0.8);
            border-radius: 10px;
            border: 2px solid var(--orange);
        }
        
        .key-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .key-box {
            width: 60px;
            height: 60px;
            background: var(--orange);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 900;
            box-shadow: 0 4px 10px rgba(255, 107, 53, 0.5);
            transition: all 0.1s;
        }
        
        .key-box.active {
            transform: scale(0.9);
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.5);
        }
        
        .key-label {
            font-size: 1.2rem;
            font-weight: 700;
            text-transform: uppercase;
        }
        
        .result-screen {
            display: none;
            text-align: center;
            padding: 40px;
            background: rgba(0, 78, 137, 0.2);
            border: 3px solid var(--blue);
            border-radius: 15px;
            margin-top: 20px;
        }
        
        .result-title {
            font-family: 'Bebas Neue', cursive;
            font-size: 3rem;
            color: var(--yellow);
            margin-bottom: 20px;
            text-shadow: 0 0 20px var(--yellow);
        }
        
        .result-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .result-stat {
            padding: 20px;
            background: rgba(26, 26, 46, 0.8);
            border-radius: 10px;
            border: 2px solid var(--orange);
        }
        
        .stat-label {
            font-size: 1rem;
            color: var(--yellow);
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 900;
            color: var(--white);
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 3rem;
            }
            
            .subtitle {
                font-size: 1rem;
            }
            
            #game-canvas {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üèÄ DRIBBLE MASTER</h1>
            <div class="subtitle">„Éê„Çπ„Ç±„É™„Ç∫„É†„Ç≤„Éº„É† - PCÁâà</div>
        </header>
        
        <div id="setup-screen">
            <div class="setup-panel">
                <div class="setup-grid">
                    <div class="input-group">
                        <label for="music-file">üéµ Èü≥Ê•Ω„Éï„Ç°„Ç§„É´</label>
                        <input type="file" id="music-file" accept="audio/*">
                    </div>
                    
                    <div class="input-group">
                        <label for="bpm">‚ô¨ BPM</label>
                        <input type="number" id="bpm" value="120" min="60" max="200">
                    </div>
                    
                    <div class="input-group">
                        <label for="difficulty">‚≠ê Èõ£ÊòìÂ∫¶</label>
                        <select id="difficulty">
                            <option value="easy">„Ç§„Éº„Ç∏„Éº</option>
                            <option value="normal" selected>„Éé„Éº„Éû„É´</option>
                            <option value="hard">„Éè„Éº„Éâ</option>
                        </select>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" id="start-btn" disabled>„Ç≤„Éº„É†„Çπ„Çø„Éº„Éà</button>
                </div>
            </div>
            
            <div class="key-guide">
                <div class="key-item">
                    <div class="key-box" id="left-key">‚Üê</div>
                    <div class="key-label">Â∑¶„Éâ„É™„Éñ„É´</div>
                </div>
                <div class="key-item">
                    <div class="key-box" id="right-key">‚Üí</div>
                    <div class="key-label">Âè≥„Éâ„É™„Éñ„É´</div>
                </div>
            </div>
        </div>
        
        <div id="game-container">
            <canvas id="game-canvas"></canvas>
            
            <div class="score-panel">
                <div class="score-item">
                    <div class="score-label">Score</div>
                    <div class="score-value" id="score">0</div>
                </div>
                <div class="score-item">
                    <div class="score-label">Combo</div>
                    <div class="score-value" id="combo">0</div>
                </div>
                <div class="score-item">
                    <div class="score-label">Perfect</div>
                    <div class="score-value" id="perfect">0</div>
                </div>
                <div class="score-item">
                    <div class="score-label">Good</div>
                    <div class="score-value" id="good">0</div>
                </div>
                <div class="score-item">
                    <div class="score-label">Miss</div>
                    <div class="score-value" id="miss">0</div>
                </div>
            </div>
            
            <div class="controls">
                <button class="btn" id="back-btn">„É°„Éã„É•„Éº„Å´Êàª„Çã</button>
            </div>
        </div>
        
        <div class="result-screen" id="result-screen">
            <div class="result-title">üèÜ GAME OVER üèÜ</div>
            <div class="result-stats">
                <div class="result-stat">
                    <div class="stat-label">Final Score</div>
                    <div class="stat-value" id="final-score">0</div>
                </div>
                <div class="result-stat">
                    <div class="stat-label">Max Combo</div>
                    <div class="stat-value" id="max-combo">0</div>
                </div>
                <div class="result-stat">
                    <div class="stat-label">Perfect</div>
                    <div class="stat-value" id="final-perfect">0</div>
                </div>
                <div class="result-stat">
                    <div class="stat-label">Good</div>
                    <div class="stat-value" id="final-good">0</div>
                </div>
                <div class="result-stat">
                    <div class="stat-label">Miss</div>
                    <div class="stat-value" id="final-miss">0</div>
                </div>
                <div class="result-stat">
                    <div class="stat-label">Á≤æÂ∫¶</div>
                    <div class="stat-value" id="accuracy">0%</div>
                </div>
            </div>
            <button class="btn" id="retry-btn">„ÇÇ„ÅÜ‰∏ÄÂ∫¶„Éó„É¨„Ç§</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        
        // Canvas setup
        function resizeCanvas() {
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        // Game state
        let gameState = {
            isPlaying: false,
            score: 0,
            combo: 0,
            maxCombo: 0,
            perfect: 0,
            good: 0,
            miss: 0,
            notes: [],
            audioContext: null,
            audioBuffer: null,
            audioSource: null,
            startTime: null,
            currentTime: 0,
            bpm: 120,
            difficulty: 'normal'
        };
        
        // Note class
        class Note {
            constructor(time, type) {
                this.time = time;
                this.type = type; // 'left', 'right', 'power-left', 'power-right', 'leg-through', 'back-change'
                this.hit = false;
                this.missed = false;
                this.x = canvas.width;
                this.yRatio = 0.5; // ÂÖ®„Å¶‰∏≠Â§Æ„É¨„Éº„É≥„Å´Áµ±‰∏Ä
                this.speed = 300;
                this.showArrow = true; // „Éá„Éï„Ç©„É´„Éà„ÅØtrueÔºàgeneratePattern„Åß‰∏äÊõ∏„ÅçÔºâ
                this.baseType = null; // generatePattern„ÅßË®≠ÂÆö„Åï„Çå„Çã
                
                // „Çø„Ç§„Éó„Å´Âøú„Åò„Å¶ÂçäÂæÑ„ÇíË®≠ÂÆö
                if (type.includes('power')) {
                    this.radius = 40; // Â§ß„Åç„ÇÅ
                } else {
                    this.radius = 30;
                }
            }
            
            update(currentTime, deltaTime) {
                const timeUntilHit = this.time - currentTime;
                this.x = canvas.width * 0.7 + (timeUntilHit * this.speed);
            }
            
            getBaseType() {
                // baseType„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Çå„Å∞„Åù„Çå„ÇíËøî„Åô
                if (this.baseType) {
                    return this.baseType;
                }
                
                // Âü∫Êú¨„Çø„Ç§„Éó„ÇíÂèñÂæóÔºàleft or rightÔºâ
                if (this.type.includes('left')) {
                    return 'left';
                }
                return 'right';
            }
            
            draw() {
                if (this.hit || this.missed) return;
                
                const y = canvas.height * this.yRatio;
                
                ctx.save();
                
                // Glow effect
                const gradient = ctx.createRadialGradient(this.x, y, 0, this.x, y, this.radius * 1.5);
                
                // „Çø„Ç§„ÉóÂà•„ÅÆËâ≤Ë®≠ÂÆö
                let color1, color2;
                if (this.type === 'leg-through') {
                    // „É¨„ÉÉ„Ç∞„Çπ„É´„ÉºÔºöÁ¥´Á≥ª
                    color1 = 'rgba(138, 43, 226, 0.8)';
                    color2 = 'rgba(138, 43, 226, 0)';
                } else if (this.type === 'back-change') {
                    // „Éê„ÉÉ„ÇØ„ÉÅ„Çß„É≥„Ç∏ÔºöÁ∑ëÁ≥ª
                    color1 = 'rgba(34, 197, 94, 0.8)';
                    color2 = 'rgba(34, 197, 94, 0)';
                } else if (this.getBaseType() === 'left') {
                    // Â∑¶Á≥ªÔºöÈùí
                    color1 = 'rgba(0, 78, 137, 0.8)';
                    color2 = 'rgba(0, 78, 137, 0)';
                } else {
                    // Âè≥Á≥ªÔºö„Ç™„É¨„É≥„Ç∏
                    color1 = 'rgba(255, 107, 53, 0.8)';
                    color2 = 'rgba(255, 107, 53, 0)';
                }
                
                gradient.addColorStop(0, color1);
                gradient.addColorStop(1, color2);
                ctx.fillStyle = gradient;
                ctx.fillRect(this.x - this.radius * 1.5, y - this.radius * 1.5, 
                           this.radius * 3, this.radius * 3);
                
                // Note circle
                ctx.beginPath();
                ctx.arc(this.x, y, this.radius, 0, Math.PI * 2);
                
                if (this.type === 'leg-through') {
                    ctx.fillStyle = '#8B2BE2'; // Á¥´
                } else if (this.type === 'back-change') {
                    ctx.fillStyle = '#22C55E'; // Á∑ë
                } else if (this.getBaseType() === 'left') {
                    ctx.fillStyle = '#004E89'; // Èùí
                } else {
                    ctx.fillStyle = '#FF6B35'; // „Ç™„É¨„É≥„Ç∏
                }
                
                ctx.fill();
                ctx.strokeStyle = '#FFD23F';
                ctx.lineWidth = this.type.includes('power') ? 4 : 3;
                ctx.stroke();
                
                // Arrow (Âàá„ÇäÊõø„Çè„ÇãÊôÇ„Å†„ÅëË°®Á§∫)
                if (this.showArrow) {
                    ctx.fillStyle = '#fff';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    
                    let arrow;
                    if (this.type === 'leg-through') {
                        // „É¨„ÉÉ„Ç∞„Çπ„É´„ÉºÔºö‰∏°Áü¢Âç∞
                        ctx.font = 'bold 28px Arial';
                        arrow = '‚áÑ';
                    } else if (this.type === 'back-change') {
                        // „Éê„ÉÉ„ÇØ„ÉÅ„Çß„É≥„Ç∏Ôºö„Ç´„Éº„ÉñÁü¢Âç∞
                        ctx.font = 'bold 28px Arial';
                        arrow = this.getBaseType() === 'left' ? '‚Ü©' : '‚Ü™';
                    } else {
                        // ÈÄöÂ∏∏ÔºöÂ∑¶Âè≥Áü¢Âç∞
                        ctx.font = 'bold 30px Arial';
                        arrow = this.getBaseType() === 'left' ? '‚Üê' : '‚Üí';
                    }
                    
                    ctx.fillText(arrow, this.x, y);
                }
                
                ctx.restore();
            }
        }
        
        // Generate note pattern based on BPM and difficulty
        function generatePattern(bpm, difficulty, duration) {
            const notes = [];
            const beatDuration = 60 / bpm;
            
            let density, specialChance;
            switch(difficulty) {
                case 'easy':
                    density = 2;
                    specialChance = 0.1; // 10%„ÅßÁâπÊÆä
                    break;
                case 'normal':
                    density = 1;
                    specialChance = 0.2; // 20%„ÅßÁâπÊÆä
                    break;
                case 'hard':
                    density = 0.5;
                    specialChance = 0.3; // 30%„ÅßÁâπÊÆä
                    break;
            }
            
            let prevType = null;
            let prevBaseType = null;
            
            for (let t = 3; t < duration - 2; t += beatDuration * density) {
                let type;
                const rand = Math.random();
                
                // ÁâπÊÆäÊäÄ„ÅÆÂà§ÂÆö
                if (rand < specialChance) {
                    const specialRand = Math.random();
                    if (specialRand < 0.5) {
                        // „É¨„ÉÉ„Ç∞„Çπ„É´„Éº„Åæ„Åü„ÅØ„Éê„ÉÉ„ÇØ„ÉÅ„Çß„É≥„Ç∏ÔºàÂ∑¶Âè≥Âàá„ÇäÊõø„ÅàÊäÄÔºâ
                        type = specialRand < 0.25 ? 'leg-through' : 'back-change';
                    } else {
                        // „Éë„ÉØ„Éº„Éâ„É™„Éñ„É´ÔºàÂâç„Å®Âêå„ÅòÊñπÂêëÔºâ
                        if (prevBaseType === 'left') {
                            type = 'power-left';
                        } else if (prevBaseType === 'right') {
                            type = 'power-right';
                        } else {
                            // ÊúÄÂàù„ÅÆ„Éé„Éº„Éà„ÅÆÂ†¥Âêà
                            type = Math.random() > 0.5 ? 'power-left' : 'power-right';
                        }
                    }
                } else {
                    // ÈÄöÂ∏∏„Éâ„É™„Éñ„É´
                    type = Math.random() > 0.5 ? 'left' : 'right';
                }
                
                const note = new Note(t, type);
                
                // Âü∫Êú¨„Çø„Ç§„Éó„ÇíÂèñÂæó
                let baseType;
                if (type === 'leg-through' || type === 'back-change') {
                    // Âàá„ÇäÊõø„ÅàÊäÄ„ÅÆÂ†¥Âêà„ÅØÂâç„ÅÆÈÄÜ
                    baseType = prevBaseType === 'left' ? 'right' : 'left';
                } else {
                    baseType = note.getBaseType();
                }
                
                // note„Å´baseType„ÇíË®≠ÂÆö
                note.baseType = baseType;
                
                // Ââç„ÅÆ„Éé„Éº„Éà„Å®Âü∫Êú¨„Çø„Ç§„Éó„ÅåÁï∞„Å™„ÇãÂ†¥Âêà„ÄÅ„Åæ„Åü„ÅØ„Çø„Ç§„Éó„ÅåÁâπÊÆä„Å™Â†¥Âêà„Å´Áü¢Âç∞Ë°®Á§∫
                note.showArrow = (prevBaseType !== baseType) || 
                                 type === 'leg-through' || 
                                 type === 'back-change' ||
                                 type.includes('power');
                
                prevType = type;
                prevBaseType = baseType;
                
                notes.push(note);
            }
            
            return notes;
        }
        
        // Draw judge line
        function drawJudgeLine() {
            const x = canvas.width * 0.35; // ‰∏≠Â§ÆÂØÑ„Çä
            
            // Single center lane
            ctx.save();
            ctx.strokeStyle = '#FFD23F';
            ctx.lineWidth = 4;
            ctx.setLineDash([10, 5]);
            ctx.beginPath();
            ctx.moveTo(0, canvas.height * 0.5);
            ctx.lineTo(canvas.width, canvas.height * 0.5);
            ctx.stroke();
            ctx.restore();
            
            // Judge line
            ctx.save();
            ctx.strokeStyle = '#FFD23F';
            ctx.lineWidth = 5;
            ctx.shadowBlur = 20;
            ctx.shadowColor = '#FFD23F';
            ctx.beginPath();
            ctx.moveTo(x, canvas.height * 0.4);
            ctx.lineTo(x, canvas.height * 0.6);
            ctx.stroke();
            ctx.restore();
            
            // Judge circle (single center circle)
            ctx.beginPath();
            ctx.arc(x, canvas.height * 0.5, 35, 0, Math.PI * 2);
            ctx.strokeStyle = '#FFD23F';
            ctx.lineWidth = 4;
            ctx.stroke();
        }
        
        // Draw judgment text
        let judgmentText = null;
        let judgmentTime = 0;
        
        function showJudgment(text, color) {
            judgmentText = { text, color };
            judgmentTime = Date.now();
        }
        
        function drawJudgment() {
            if (!judgmentText) return;
            
            const elapsed = Date.now() - judgmentTime;
            if (elapsed > 500) {
                judgmentText = null;
                return;
            }
            
            const alpha = 1 - (elapsed / 500);
            const scale = 1 + (elapsed / 500) * 0.5;
            
            ctx.save();
            ctx.globalAlpha = alpha;
            ctx.font = `bold ${40 * scale}px 'Kanit'`;
            ctx.fillStyle = judgmentText.color;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.shadowBlur = 20;
            ctx.shadowColor = judgmentText.color;
            ctx.fillText(judgmentText.text, canvas.width / 2, canvas.height / 2);
            ctx.restore();
        }
        
        // Check hit
        function checkHit(type) {
            const judgeX = canvas.width * 0.35; // ‰∏≠Â§ÆÂØÑ„Çä
            const perfectRange = 50;
            const goodRange = 100;
            const missRange = canvas.width * 0.25;
            
            let bestNote = null;
            let bestDistance = Infinity;
            
            for (let note of gameState.notes) {
                if (note.hit || note.missed) continue;
                
                // Âü∫Êú¨„Çø„Ç§„Éó„ÅßÂà§ÂÆöÔºàleft or rightÔºâ
                if (note.getBaseType() !== type) continue;
                
                const distance = Math.abs(note.x - judgeX);
                if (distance < bestDistance) {
                    bestDistance = distance;
                    bestNote = note;
                }
            }
            
            if (!bestNote) return false;
            
            // „Çπ„Ç≥„Ç¢„ÅØ„Çø„Ç§„Éó„Å´„Çà„Å£„Å¶Â§âÂãï
            let baseScore = 100;
            if (bestNote.type.includes('power')) {
                baseScore = 150; // „Éë„ÉØ„Éº„ÅØÈ´òÂæóÁÇπ
            } else if (bestNote.type === 'leg-through' || bestNote.type === 'back-change') {
                baseScore = 200; // ÁâπÊÆäÊäÄ„ÅØ„Åï„Çâ„Å´È´òÂæóÁÇπ
            }
            
            if (bestDistance < perfectRange) {
                bestNote.hit = true;
                gameState.score += baseScore;
                gameState.combo++;
                gameState.perfect++;
                showJudgment('PERFECT!', '#39FF14');
                updateUI();
                return true;
            } else if (bestDistance < goodRange) {
                bestNote.hit = true;
                gameState.score += Math.floor(baseScore * 0.5);
                gameState.combo++;
                gameState.good++;
                showJudgment('GOOD', '#FFD23F');
                updateUI();
                return true;
            } else if (bestDistance < missRange) {
                // „Çø„ÉÉ„Éó„Åó„Åü„Åë„Å©Â§ñ„Åó„ÅüÂ†¥Âêà„ÅÆ„ÅøMISSË°®Á§∫
                gameState.combo = 0;
                gameState.miss++;
                showJudgment('MISS', '#ff0000');
                updateUI();
            }
            
            return false;
        }
        
        // Game loop
        let lastTime = 0;
        function gameLoop(timestamp) {
            if (!gameState.isPlaying) return;
            
            const deltaTime = (timestamp - lastTime) / 1000;
            lastTime = timestamp;
            
            if (gameState.audioContext) {
                gameState.currentTime = gameState.audioContext.currentTime - gameState.startTime;
            }
            
            // Clear canvas
            ctx.fillStyle = '#16213e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw judge line
            drawJudgeLine();
            
            // Update and draw notes
            let activeNotes = 0;
            for (let note of gameState.notes) {
                note.update(gameState.currentTime, deltaTime);
                note.draw();
                
                // Check if note is missed (ÊµÅ„ÇåÂéª„Å£„ÅüÊôÇ„ÅØ„Ç´„Ç¶„É≥„Éà„ÅÆ„Åø„ÄÅË°®Á§∫„Å™„Åó)
                if (!note.hit && !note.missed && note.x < canvas.width * 0.1) {
                    note.missed = true;
                    gameState.combo = 0;
                    gameState.miss++;
                    updateUI();
                }
                
                if (!note.hit && !note.missed) {
                    activeNotes++;
                }
            }
            
            // Draw judgment text
            drawJudgment();
            
            // Check if game is over
            if (activeNotes === 0 && gameState.currentTime > gameState.notes[gameState.notes.length - 1].time + 2) {
                endGame();
                return;
            }
            
            requestAnimationFrame(gameLoop);
        }
        
        // Update UI
        function updateUI() {
            document.getElementById('score').textContent = gameState.score;
            document.getElementById('combo').textContent = gameState.combo;
            document.getElementById('perfect').textContent = gameState.perfect;
            document.getElementById('good').textContent = gameState.good;
            document.getElementById('miss').textContent = gameState.miss;
            
            if (gameState.combo > gameState.maxCombo) {
                gameState.maxCombo = gameState.combo;
            }
        }
        
        // Start game
        async function startGame() {
            const audioFile = document.getElementById('music-file').files[0];
            if (!audioFile) return;
            
            gameState.bpm = parseInt(document.getElementById('bpm').value);
            gameState.difficulty = document.getElementById('difficulty').value;
            
            // Reset state
            gameState.score = 0;
            gameState.combo = 0;
            gameState.maxCombo = 0;
            gameState.perfect = 0;
            gameState.good = 0;
            gameState.miss = 0;
            
            // Load audio
            const arrayBuffer = await audioFile.arrayBuffer();
            gameState.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            gameState.audioBuffer = await gameState.audioContext.decodeAudioData(arrayBuffer);
            
            // Generate notes
            const duration = gameState.audioBuffer.duration;
            gameState.notes = generatePattern(gameState.bpm, gameState.difficulty, duration);
            
            // Show game screen
            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('game-container').style.display = 'block';
            document.getElementById('result-screen').style.display = 'none';
            
            resizeCanvas();
            updateUI();
            
            // Start audio
            gameState.audioSource = gameState.audioContext.createBufferSource();
            gameState.audioSource.buffer = gameState.audioBuffer;
            gameState.audioSource.connect(gameState.audioContext.destination);
            gameState.audioSource.start();
            
            gameState.startTime = gameState.audioContext.currentTime;
            gameState.isPlaying = true;
            lastTime = performance.now();
            requestAnimationFrame(gameLoop);
        }
        
        // End game
        function endGame() {
            gameState.isPlaying = false;
            
            if (gameState.audioSource) {
                gameState.audioSource.stop();
            }
            
            // Show results
            document.getElementById('final-score').textContent = gameState.score;
            document.getElementById('max-combo').textContent = gameState.maxCombo;
            document.getElementById('final-perfect').textContent = gameState.perfect;
            document.getElementById('final-good').textContent = gameState.good;
            document.getElementById('final-miss').textContent = gameState.miss;
            
            const total = gameState.perfect + gameState.good + gameState.miss;
            const accuracy = total > 0 ? Math.round(((gameState.perfect + gameState.good) / total) * 100) : 0;
            document.getElementById('accuracy').textContent = accuracy + '%';
            
            document.getElementById('game-container').style.display = 'none';
            document.getElementById('result-screen').style.display = 'block';
        }
        
        // Keyboard controls
        const leftKeyElement = document.getElementById('left-key');
        const rightKeyElement = document.getElementById('right-key');
        
        document.addEventListener('keydown', (e) => {
            if (!gameState.isPlaying && e.key !== 'ArrowLeft' && e.key !== 'ArrowRight') return;
            
            if (e.key === 'ArrowLeft') {
                leftKeyElement.classList.add('active');
                if (gameState.isPlaying) {
                    checkHit('left');
                }
            } else if (e.key === 'ArrowRight') {
                rightKeyElement.classList.add('active');
                if (gameState.isPlaying) {
                    checkHit('right');
                }
            }
        });
        
        document.addEventListener('keyup', (e) => {
            if (e.key === 'ArrowLeft') {
                leftKeyElement.classList.remove('active');
            } else if (e.key === 'ArrowRight') {
                rightKeyElement.classList.remove('active');
            }
        });
        
        // Button events
        document.getElementById('music-file').addEventListener('change', (e) => {
            document.getElementById('start-btn').disabled = !e.target.files[0];
        });
        
        document.getElementById('start-btn').addEventListener('click', startGame);
        
        document.getElementById('back-btn').addEventListener('click', () => {
            gameState.isPlaying = false;
            if (gameState.audioContext) {
                gameState.audioContext.close();
            }
            document.getElementById('setup-screen').style.display = 'block';
            document.getElementById('game-container').style.display = 'none';
        });
        
        document.getElementById('retry-btn').addEventListener('click', () => {
            if (gameState.audioContext) {
                gameState.audioContext.close();
            }
            document.getElementById('result-screen').style.display = 'none';
            document.getElementById('setup-screen').style.display = 'block';
        });
    </script>
</body>
</html>
